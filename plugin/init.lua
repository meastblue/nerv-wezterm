local wezterm = require("wezterm")

local M = {}

local colors = {
	["aurora-frost"] = {
		rosewater = "#FF738A",
		flamingo = "#FF955C",
		pink = "#F38CEC",
		mauve = "#B78AFF",
		red = "#E35535",
		maroon = "#FF738A",
		peach = "#FF955C",
		yellow = "#EACD61",
		green = "#3CEC85",
		teal = "#22ECDB",
		sky = "#69C3FF",
		sapphire = "#69C3FF",
		blue = "#69C3FF",
		lavender = "#B78AFF",
		text = "#d0d7e4",
		subtext1 = "#aebbd3",
		subtext0 = "#9eadca",
		overlay2 = "#7d91b8",
		overlay1 = "#5c76a6",
		overlay0 = "#495e85",
		surface2 = "#374764",
		surface1 = "#2e3b54",
		surface0 = "#253043",
		base = "#1c2433",
		mantle = "#181f2c",
		crust = "#151b26",
		accent = "#8196b5",
	},
	["aurora-storm"] = {
		rosewater = "#FF738A",
		flamingo = "#FF955C",
		pink = "#F38CEC",
		mauve = "#B78AFF",
		red = "#E35535",
		maroon = "#FF738A",
		peach = "#FF955C",
		yellow = "#EACD61",
		green = "#3CEC85",
		teal = "#22ECDB",
		sky = "#69C3FF",
		sapphire = "#69C3FF",
		blue = "#69C3FF",
		lavender = "#B78AFF",
		text = "#d8dde7",
		subtext1 = "#b8c2d4",
		subtext0 = "#a8b5ca",
		overlay2 = "#8899b7",
		overlay1 = "#697ea4",
		overlay0 = "#526587",
		surface2 = "#3f4e68",
		surface1 = "#354258",
		surface0 = "#2c3648",
		base = "#222A38",
		mantle = "#1e2532",
		crust = "#1a202b",
		accent = "#9DACC3",
	},
	["aurora-berry"] = {
		rosewater = "#FF738A",
		flamingo = "#FF955C",
		pink = "#F38CEC",
		mauve = "#B78AFF",
		red = "#E35535",
		maroon = "#FF738A",
		peach = "#FF955C",
		yellow = "#EACD61",
		green = "#3CEC85",
		teal = "#22ECDB",
		sky = "#69C3FF",
		sapphire = "#69C3FF",
		blue = "#69C3FF",
		lavender = "#B78AFF",
		text = "#bcc1dc",
		subtext1 = "#99a2cc",
		subtext0 = "#8893c4",
		overlay2 = "#6673b3",
		overlay1 = "#4c5a99",
		overlay0 = "#3b4677",
		surface2 = "#2b3255",
		surface1 = "#222844",
		surface0 = "#1a1e33",
		base = "#111422",
		mantle = "#0e101b",
		crust = "#0a0c14",
		accent = "#8eb0e6",
	},
	["ember-terra"] = {
		rosewater = "#ff6188",
		flamingo = "#fc9867",
		pink = "#e991e3",
		mauve = "#ab9df2",
		red = "#fc6a67",
		maroon = "#ff6188",
		peach = "#fc9867",
		yellow = "#ffd866",
		green = "#a9dc76",
		teal = "#78e8c6",
		sky = "#78dce8",
		sapphire = "#78dce8",
		blue = "#78dce8",
		lavender = "#ab9df2",
		text = "#d9d6db",
		subtext1 = "#bfbac4",
		subtext0 = "#b2acb8",
		overlay2 = "#9991a1",
		overlay1 = "#7f7589",
		overlay0 = "#665e6e",
		surface2 = "#4c4652",
		surface1 = "#403a45",
		surface0 = "#332f37",
		base = "#262329",
		mantle = "#211e23",
		crust = "#1c1a1e",
		accent = "#b0a2a6",
	},
	["ember-steel"] = {
		rosewater = "#ff6188",
		flamingo = "#fc9867",
		pink = "#e991e3",
		mauve = "#ab9df2",
		red = "#fc6a67",
		maroon = "#ff6188",
		peach = "#fc9867",
		yellow = "#ffd866",
		green = "#a9dc76",
		teal = "#78e8c6",
		sky = "#78dce8",
		sapphire = "#78dce8",
		blue = "#78dce8",
		lavender = "#ab9df2",
		text = "#d0d3de",
		subtext1 = "#b2b7c9",
		subtext0 = "#a3a9bf",
		overlay2 = "#858daa",
		overlay1 = "#677294",
		overlay0 = "#525b76",
		surface2 = "#3d4458",
		surface1 = "#333849",
		surface0 = "#282d3a",
		base = "#1e212b",
		mantle = "#1a1c25",
		crust = "#16181f",
		accent = "#98a2b5",
	},
	["ember-stone"] = {
		rosewater = "#ff6188",
		flamingo = "#fc9867",
		pink = "#e991e3",
		mauve = "#ab9df2",
		red = "#fc6a67",
		maroon = "#ff6188",
		peach = "#fc9867",
		yellow = "#ffd866",
		green = "#a9dc76",
		teal = "#78e8c6",
		sky = "#78dce8",
		sapphire = "#78dce8",
		blue = "#78dce8",
		lavender = "#ab9df2",
		text = "#dee0e4",
		subtext1 = "#c2c6cd",
		subtext0 = "#b4b9c1",
		overlay2 = "#989eaa",
		overlay1 = "#7c8493",
		overlay0 = "#646b79",
		surface2 = "#4d525d",
		surface1 = "#41464f",
		surface0 = "#363941",
		base = "#2A2D33",
		mantle = "#25282d",
		crust = "#212328",
		accent = "#9AA2A6",
	},
	["neon-grape"] = {
		rosewater = "#FF478D",
		flamingo = "#FF7135",
		pink = "#E66DFF",
		mauve = "#A95EFF",
		red = "#D62C2C",
		maroon = "#FF478D",
		peach = "#FF7135",
		yellow = "#FFB638",
		green = "#42DD76",
		teal = "#14E5D4",
		sky = "#28A9FF",
		sapphire = "#28A9FF",
		blue = "#28A9FF",
		lavender = "#A95EFF",
		text = "#c7bfe8",
		subtext1 = "#a599db",
		subtext0 = "#9486d5",
		overlay2 = "#7360c8",
		overlay1 = "#553fb6",
		overlay0 = "#433290",
		surface2 = "#32256a",
		surface1 = "#291e57",
		surface0 = "#201844",
		base = "#171131",
		mantle = "#130e29",
		crust = "#100c22",
		accent = "#A680FF",
	},
	["neon-void"] = {
		rosewater = "#FF478D",
		flamingo = "#FF7135",
		pink = "#E66DFF",
		mauve = "#A95EFF",
		red = "#D62C2C",
		maroon = "#FF478D",
		peach = "#FF7135",
		yellow = "#FFB638",
		green = "#42DD76",
		teal = "#14E5D4",
		sky = "#28A9FF",
		sapphire = "#28A9FF",
		blue = "#28A9FF",
		lavender = "#A95EFF",
		text = "#c5c5cb",
		subtext1 = "#a9a9b4",
		subtext0 = "#9b9ba8",
		overlay2 = "#808091",
		overlay1 = "#676776",
		overlay0 = "#4f4f5b",
		surface2 = "#383840",
		surface1 = "#2c2c32",
		surface0 = "#202025",
		base = "#141417",
		mantle = "#0f0f12",
		crust = "#0b0b0c",
		accent = "#AAAAAA",
	},
	["eclipse"] = {
		rosewater = "#f154a0",
		flamingo = "#e8913b",
		pink = "#df96d9",
		mauve = "#858bf7",
		red = "#f45645",
		maroon = "#f154a0",
		peach = "#e8913b",
		yellow = "#e2ae10",
		green = "#a5b82e",
		teal = "#26bbae",
		sky = "#4db0f7",
		sapphire = "#4db0f7",
		blue = "#4db0f7",
		lavender = "#858bf7",
		text = "#c3e0e9",
		subtext1 = "#9eccdb",
		subtext0 = "#8bc3d5",
		overlay2 = "#66afc7",
		overlay1 = "#439bb7",
		overlay0 = "#357b91",
		surface2 = "#275b6c",
		surface1 = "#214c59",
		surface0 = "#1a3c47",
		base = "#132c34",
		mantle = "#10262d",
		crust = "#0e1f25",
		accent = "#47cfc4",
	},
	["depths"] = {
		rosewater = "#ee5d75",
		flamingo = "#DC8255",
		pink = "#d194cd",
		mauve = "#978dd6",
		red = "#B4552D",
		maroon = "#ee5d75",
		peach = "#DC8255",
		yellow = "#f6cc73",
		green = "#97c892",
		teal = "#59c6c8",
		sky = "#5fb2df",
		sapphire = "#5fb2df",
		blue = "#5fb2df",
		lavender = "#978dd6",
		text = "#cddde6",
		subtext1 = "#abc6d5",
		subtext0 = "#9abbcd",
		overlay2 = "#78a4bc",
		overlay1 = "#568dab",
		overlay0 = "#457189",
		surface2 = "#345567",
		surface1 = "#2b4756",
		surface0 = "#233945",
		base = "#1a2b34",
		mantle = "#17252d",
		crust = "#132026",
		accent = "#97c892",
	},
	["espresso"] = {
		rosewater = "#f77a6a",
		flamingo = "#ffa777",
		pink = "#E480AD",
		mauve = "#9991F1",
		red = "#f24343",
		maroon = "#f77a6a",
		peach = "#ffa777",
		yellow = "#f7d979",
		green = "#9DCC57",
		teal = "#3ceaa8",
		sky = "#6EDDD6",
		sapphire = "#6EDDD6",
		blue = "#6EDDD6",
		lavender = "#9991F1",
		text = "#dbd7d6",
		subtext1 = "#c4bcba",
		subtext0 = "#b8aeac",
		overlay2 = "#a19391",
		overlay1 = "#897975",
		overlay0 = "#6e605e",
		surface2 = "#524846",
		surface1 = "#453c3a",
		surface0 = "#37302f",
		base = "#292423",
		mantle = "#231f1e",
		crust = "#1e1a1a",
		accent = "#F09177",
	},
	["crystal-onyx"] = {
		rosewater = "#EC7886",
		flamingo = "#ffaa7d",
		pink = "#e4a3df",
		mauve = "#bc98ff",
		red = "#fd604f",
		maroon = "#EC7886",
		peach = "#ffaa7d",
		yellow = "#F5DF76",
		green = "#AFEA7B",
		teal = "#22D3B1",
		sky = "#7fd7f5",
		sapphire = "#7fd7f5",
		blue = "#7fd7f5",
		lavender = "#bc98ff",
		text = "#c8c8d5",
		subtext1 = "#aaaac0",
		subtext0 = "#9c9cb5",
		overlay2 = "#7f7f9f",
		overlay1 = "#656586",
		overlay0 = "#4f4f69",
		surface2 = "#39394c",
		surface1 = "#2e2e3d",
		surface0 = "#23232f",
		base = "#181820",
		mantle = "#14141a",
		crust = "#0f0f14",
		accent = "#dbdeea",
	},
	["crystal-cosmos"] = {
		rosewater = "#EC7886",
		flamingo = "#ffaa7d",
		pink = "#e4a3df",
		mauve = "#bc98ff",
		red = "#fd604f",
		maroon = "#EC7886",
		peach = "#ffaa7d",
		yellow = "#F5DF76",
		green = "#AFEA7B",
		teal = "#22D3B1",
		sky = "#7fd7f5",
		sapphire = "#7fd7f5",
		blue = "#7fd7f5",
		lavender = "#bc98ff",
		text = "#c3d2de",
		subtext1 = "#a1b9cd",
		subtext0 = "#91adc4",
		overlay2 = "#7094b2",
		overlay1 = "#537b9b",
		overlay0 = "#42617a",
		surface2 = "#304759",
		surface1 = "#273948",
		surface0 = "#1e2c38",
		base = "#151f27",
		mantle = "#111a20",
		crust = "#0e141a",
		accent = "#dbefff",
	},
	["daylight"] = {
		rosewater = "#e8386a",
		flamingo = "#d06200",
		pink = "#e022b4",
		mauve = "#8737e6",
		red = "#d03333",
		maroon = "#e8386a",
		peach = "#d06200",
		yellow = "#bb9600",
		green = "#189433",
		teal = "#009999",
		sky = "#0073d1",
		sapphire = "#0073d1",
		blue = "#0073d1",
		lavender = "#8737e6",
		text = "#091316",
		subtext1 = "#5e6871",
		subtext0 = "#6a757f",
		overlay2 = "#76818d",
		overlay1 = "#929ba4",
		overlay0 = "#adb4bb",
		surface2 = "#bbc1c7",
		surface1 = "#c9ced2",
		surface0 = "#d7dbde",
		base = "#f3f4f5",
		mantle = "#e8eaec",
		crust = "#dde0e2",
		accent = "#22a5c9",
	},
	["sorbet-cherry"] = {
		rosewater = "#da2a5f",
		flamingo = "#b96000",
		pink = "#c121a4",
		mauve = "#7522d3",
		red = "#d12525",
		maroon = "#da2a5f",
		peach = "#b96000",
		yellow = "#c08403",
		green = "#008b17",
		teal = "#008f8f",
		sky = "#0076c5",
		sapphire = "#0076c5",
		blue = "#0076c5",
		lavender = "#7522d3",
		text = "#15070b",
		subtext1 = "#784958",
		subtext0 = "#885264",
		overlay2 = "#975c70",
		overlay1 = "#ad798b",
		overlay0 = "#c199a6",
		surface2 = "#caa9b4",
		surface1 = "#d4b8c2",
		surface0 = "#dec8cf",
		base = "#f1e8eb",
		mantle = "#e9dbe0",
		crust = "#e2cfd5",
		accent = "#d1174f",
	},
	["sorbet-mint"] = {
		rosewater = "#da2a5f",
		flamingo = "#b96000",
		pink = "#c121a4",
		mauve = "#7522d3",
		red = "#d12525",
		maroon = "#da2a5f",
		peach = "#b96000",
		yellow = "#c08403",
		green = "#008b17",
		teal = "#008f8f",
		sky = "#0076c5",
		sapphire = "#0076c5",
		blue = "#0076c5",
		lavender = "#7522d3",
		text = "#000000",
		subtext1 = "#507856",
		subtext0 = "#5a8762",
		overlay2 = "#64966d",
		overlay1 = "#82ac89",
		overlay0 = "#a1c0a6",
		surface2 = "#b0cab4",
		surface1 = "#bfd4c3",
		surface0 = "#cedfd1",
		base = "#edf3ee",
		mantle = "#e1ebe2",
		crust = "#d5e3d7",
		accent = "#2a9b7d",
	},
	["sorbet-grape"] = {
		rosewater = "#da2a5f",
		flamingo = "#b96000",
		pink = "#c121a4",
		mauve = "#7522d3",
		red = "#d12525",
		maroon = "#da2a5f",
		peach = "#b96000",
		yellow = "#c08403",
		green = "#008b17",
		teal = "#008f8f",
		sky = "#0076c5",
		sapphire = "#0076c5",
		blue = "#0076c5",
		lavender = "#7522d3",
		text = "#07060c",
		subtext1 = "#3e3b70",
		subtext0 = "#474481",
		overlay2 = "#514d92",
		overlay1 = "#6864ad",
		overlay0 = "#8985bf",
		surface2 = "#9996c8",
		surface1 = "#a9a7d1",
		surface0 = "#b9b8d9",
		base = "#dad9eb",
		mantle = "#cdcce4",
		crust = "#c0bedd",
		accent = "#422eb0",
	},
}

local mappings = {
	["aurora-frost"] = "Nube Dark - Aurora Frost",
	["aurora-storm"] = "Nube Dark - Aurora Storm",
	["aurora-berry"] = "Nube Dark - Aurora Berry",
	["ember-terra"] = "Nube Dark - Ember Terra",
	["ember-steel"] = "Nube Dark - Ember Steel",
	["ember-stone"] = "Nube Dark - Ember Stone",
	["neon-grape"] = "Nube Dark - Neon Grape",
	["neon-void"] = "Nube Dark - Neon Void",
	["eclipse"] = "Nube Dark - Eclipse",
	["depths"] = "Nube Dark - Depths",
	["espresso"] = "Nube Dark - Espresso",
	["crystal-onyx"] = "Nube Dark - Crystal Onyx",
	["crystal-cosmos"] = "Nube Dark - Crystal Cosmos",
	["daylight"] = "Nube Light - Daylight",
	["sorbet-cherry"] = "Nube Light - Sorbet Cherry",
	["sorbet-mint"] = "Nube Light - Sorbet Mint",
	["sorbet-grape"] = "Nube Light - Sorbet Grape",
}

function M.select(palette, flavor, accent)
	local c = palette[flavor]
	if not c then
		error("Unknown flavor: " .. tostring(flavor))
	end
	
	local isDark = c.base:sub(2, 3):lower() < "80"
	local accentColor = accent and c[accent] or c.accent

	return {
		foreground = c.text,
		background = c.base,

		cursor_fg = isDark and c.crust or c.base,
		cursor_bg = c.rosewater,
		cursor_border = c.rosewater,

		selection_fg = c.text,
		selection_bg = c.surface2,

		scrollbar_thumb = c.surface2,

		split = c.overlay0,

		ansi = {
			isDark and c.surface1 or c.subtext1,
			c.red,
			c.green,
			c.yellow,
			c.blue,
			c.pink,
			c.teal,
			isDark and c.subtext1 or c.surface2,
		},

		brights = {
			isDark and c.surface2 or c.subtext0,
			c.red,
			c.green,
			c.yellow,
			c.blue,
			c.pink,
			c.teal,
			isDark and c.subtext0 or c.surface1,
		},

		indexed = { [16] = c.peach, [17] = c.rosewater },

		compose_cursor = c.flamingo,

		tab_bar = {
			background = c.crust,
			active_tab = {
				bg_color = accentColor,
				fg_color = isDark and c.crust or "#ffffff",
			},
			inactive_tab = {
				bg_color = c.mantle,
				fg_color = c.text,
			},
			inactive_tab_hover = {
				bg_color = c.base,
				fg_color = c.text,
			},
			new_tab = {
				bg_color = c.surface0,
				fg_color = c.text,
			},
			new_tab_hover = {
				bg_color = c.surface1,
				fg_color = c.text,
			},
			inactive_tab_edge = c.surface0,
		},

		visual_bell = c.surface0,
	}
end

local function select_for_appearance(appearance, options)
	if appearance:find("Dark") then
		return options.dark
	else
		return options.light
	end
end

local function tableMerge(t1, t2)
	for k, v in pairs(t2) do
		if type(v) == "table" then
			if type(t1[k] or false) == "table" then
				tableMerge(t1[k] or {}, t2[k] or {})
			else
				t1[k] = v
			end
		else
			t1[k] = v
		end
	end
	return t1
end

function M.apply_to_config(c, opts)
	if not opts then
		opts = {}
	end

	local defaults = {
		flavor = "aurora-frost",
		accent = nil,
		sync = false,
		sync_flavors = { light = "daylight", dark = "aurora-frost" },
		color_overrides = {},
		token_overrides = {},
	}

	local o = tableMerge(defaults, opts)

	local color_schemes = {}
	local palette = tableMerge(colors, o.color_overrides)
	for flavor, name in pairs(mappings) do
		local spec = M.select(palette, flavor, o.accent)
		local overrides = o.token_overrides[flavor] or {}
		color_schemes[name] = tableMerge(spec, overrides)
	end
	if c.color_schemes == nil then
		c.color_schemes = {}
	end
	c.color_schemes = tableMerge(c.color_schemes, color_schemes)

	if opts.sync then
		c.color_scheme = select_for_appearance(wezterm.gui.get_appearance(), {
			dark = mappings[o.sync_flavors.dark],
			light = mappings[o.sync_flavors.light],
		})
		c.command_palette_bg_color = select_for_appearance(wezterm.gui.get_appearance(), {
			dark = colors[o.sync_flavors.dark].crust,
			light = colors[o.sync_flavors.light].crust,
		})
		c.command_palette_fg_color = select_for_appearance(wezterm.gui.get_appearance(), {
			dark = colors[o.sync_flavors.dark].text,
			light = colors[o.sync_flavors.light].text,
		})
	else
		c.color_scheme = mappings[o.flavor]
		c.command_palette_bg_color = colors[o.flavor].crust
		c.command_palette_fg_color = colors[o.flavor].text
	end

	local window_frame = {
		active_titlebar_bg = colors[o.flavor].crust,
		active_titlebar_fg = colors[o.flavor].text,
		inactive_titlebar_bg = colors[o.flavor].crust,
		inactive_titlebar_fg = colors[o.flavor].text,
		button_fg = colors[o.flavor].text,
		button_bg = colors[o.flavor].base,
	}

	if c.window_frame == nil then
		c.window_frame = {}
	end
	c.window_frame = tableMerge(c.window_frame, window_frame)
end

M.colors = colors
M.mappings = mappings

return M
